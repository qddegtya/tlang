/**
 * Bundle tlang source files into a static TypeScript module
 *
 * This script reads all TypeScript files from ../src/ and generates a module
 * that exports them as string constants. This allows the playground to be
 * completely static and deployable without a backend server.
 *
 * Usage: node scripts/bundle-tlang-sources.js
 */

import { readFileSync, writeFileSync, readdirSync, statSync, mkdirSync } from 'fs'
import { join, relative, dirname } from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

const TLANG_SRC_DIR = join(__dirname, '../../src')
const OUTPUT_FILE = join(__dirname, '../src/generated/tlangSources.ts')

/**
 * Recursively get all .ts files from a directory
 */
function getAllTsFiles(dir, fileList = []) {
  const files = readdirSync(dir)

  files.forEach(file => {
    const filePath = join(dir, file)
    const stat = statSync(filePath)

    if (stat.isDirectory()) {
      getAllTsFiles(filePath, fileList)
    } else if (file.endsWith('.ts')) {
      fileList.push(filePath)
    }
  })

  return fileList
}

/**
 * Escape string for TypeScript template literal
 */
function escapeForTemplate(str) {
  return str
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$/g, '\\$')
}

/**
 * Main bundling logic
 */
function bundleTLangSources() {
  console.log('üì¶ Bundling tlang sources...')

  // Get all TypeScript files
  const tsFiles = getAllTsFiles(TLANG_SRC_DIR)
  console.log(`Found ${tsFiles.length} TypeScript files`)

  // Build the sources map
  const sourcesMap = {}

  tsFiles.forEach(filePath => {
    const content = readFileSync(filePath, 'utf-8')
    const relativePath = relative(TLANG_SRC_DIR, filePath)

    // Convert to virtual path format: /node_modules/tlang/core/index.ts
    const virtualPath = `/node_modules/tlang/${relativePath.replace(/\\/g, '/')}`

    sourcesMap[virtualPath] = content
  })

  // Generate TypeScript module
  const moduleContent = `/**
 * Auto-generated tlang source files bundle
 *
 * This file is generated by scripts/bundle-tlang-sources.js
 * DO NOT EDIT MANUALLY - it will be overwritten
 *
 * Generated at: ${new Date().toISOString()}
 */

export const TLANG_SOURCES: Record<string, string> = {
${Object.entries(sourcesMap).map(([path, content]) => {
  return `  '${path}': \`${escapeForTemplate(content)}\`,`
}).join('\n\n')}
}

/**
 * Package.json for tlang module resolution
 */
export const TLANG_PACKAGE_JSON = \`{
  "name": "tlang",
  "version": "0.1.0",
  "main": "./index.ts",
  "types": "./index.ts",
  "exports": {
    ".": "./index.ts",
    "./*": "./*"
  }
}\`

/**
 * Load tlang sources into a virtual file system map
 */
export function loadTLangIntoVFS(fsMap: Map<string, string>): void {
  // Add all source files
  for (const [path, content] of Object.entries(TLANG_SOURCES)) {
    fsMap.set(path, content)
  }

  // Add package.json
  fsMap.set('/node_modules/tlang/package.json', TLANG_PACKAGE_JSON)
}
`

  // Ensure output directory exists
  mkdirSync(dirname(OUTPUT_FILE), { recursive: true })

  // Write the module
  writeFileSync(OUTPUT_FILE, moduleContent, 'utf-8')

  console.log(`‚úÖ Generated ${OUTPUT_FILE}`)
  console.log(`   Bundled ${Object.keys(sourcesMap).length} files`)
}

// Run the bundler
try {
  bundleTLangSources()
} catch (error) {
  console.error('‚ùå Failed to bundle tlang sources:', error)
  process.exit(1)
}
